proj_paths <- list(
projects = "C:/Users/Kateri/Box/NSF Senegal",
alternative_projects = "C:/Users/km978/Box/NSF Senegal"
)
# Check if the Kateri path exists and resolve the project path accordingly
if (file.exists(proj_paths$projects)) {
proj <- kwb.utils::resolve(list(
projects = proj_paths$projects,
p1 = "<projects>/Data_Management/Output/Data_Analysis/Balance_Tables"
))
} else {
proj <- kwb.utils::resolve(list(
projects = proj_paths$alternative_projects,
p1 = "<projects>/Data_Management/Output/Data_Analysis/Balance_Tables"
))
}
file_path_balance_tables_df <- file.path(proj$p1, "baseline_balance_tables_data.dta")
balance_df <- read_dta(file_path_balance_tables_df)
#survey_questions <- read_csv(file.path(proj$p1, "Baseline_Survey_Questions.csv"))
#balance_df
balance_df
balance_df
# Adding a single categorical variable for household training categories
balance_df <- balance_df %>%
mutate(
# Extract the two middle characters (e.g., 2A) from hhid
group = str_sub(hhid, 3, 4),
# Assign treatment group based on the extracted group value
treatment_group = case_when(
group %in% c("0A", "0B") ~ "Control",
group %in% c("1A", "1B") ~ "Treatment1", # Public health trained
group %in% c("2A", "2B") ~ "Treatment2", # Private benefits trained
group %in% c("3A", "3B") ~ "Treatment3"  # Public and private trained
)
) %>%
select(-group)
#view(balance_df)
# Ensure 'group' is character to avoid conflicts
# balance_df <- balance_df %>%
#   mutate(group = as.character(group))
# Reshape the data
long_data <- balance_df %>%
pivot_longer(
cols = -c(hhid, hhid_village, treatment_group),  # Keep hhid and group as is, pivot all other columns
names_to = "variable",    # Create a column named "variable" for former column names
values_to = "value"       # Store values in a column named "value"
)
#view(long_data)
# View the transformed dat
###################### bring in survey questions to merge ###################################################
long_data <- long_data %>%
rename(group = treatment_group)
long_data
# long_data <- merge(long_data, survey_questions, by = "variable")
#
# view(long_data)
# survey_questions
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     treatment1 = if_else(group %in% c("1A", "1B"), 1, 0), #public health trained
#     treatment2 = if_else(group %in% c("2A", "2B"), 1, 0), # private benefits trained
#     treatment3 = if_else(group %in% c("3A", "3B"), 1, 0) # public_and_private_trained
#   ) #%>%
#   # Drop the 'group' column if it's not needed
#   #select(-group)
#
# view(balance_df)
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     public_health_trained = if_else(group %in% c("1A", "1B"), 1, 0),
#     private_benefits_trained = if_else(group %in% c("2A", "2B"), 1, 0),
#     public_and_private_trained = if_else(group %in% c("3A", "3B"), 1, 0)
#   ) %>%
#   # Drop the 'group' column if it's not needed
#   select(-group)
#
# view(balance_df)
run_regressions <- function(data, treatment_col, village_col, vars_to_test) {
results <- list()
for (var in vars_to_test) {
treatments <- unique(data[[treatment_col]])
treatments <- setdiff(treatments, 'Control')
for (arm in treatments) {
subset <- data %>% filter(.data[[treatment_col]] %in% c('Control', arm) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == arm, 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste('Control vs', arm),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
for (i in 1:(length(treatments) - 1)) {
for (j in (i + 1):length(treatments)) {
subset <- data %>% filter(.data[[treatment_col]] %in% c(treatments[i], treatments[j]) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == treatments[j], 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste(treatments[i], 'vs', treatments[j]),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
}
}
bind_rows(results)
}
library(dplyr)
library(readr)
library(tidyr)
#library(ggplot2)
#library(kwb.utils)
library(haven)
library(data.table)
#library(rtf)
library(tidyverse)
library(estimatr)
library(broom)
library(kableExtra)
library(sandwich)
library(lmtest)
run_regressions <- function(data, treatment_col, village_col, vars_to_test) {
results <- list()
for (var in vars_to_test) {
treatments <- unique(data[[treatment_col]])
treatments <- setdiff(treatments, 'Control')
for (arm in treatments) {
subset <- data %>% filter(.data[[treatment_col]] %in% c('Control', arm) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == arm, 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste('Control vs', arm),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
for (i in 1:(length(treatments) - 1)) {
for (j in (i + 1):length(treatments)) {
subset <- data %>% filter(.data[[treatment_col]] %in% c(treatments[i], treatments[j]) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == treatments[j], 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste(treatments[i], 'vs', treatments[j]),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
}
}
bind_rows(results)
}
vars_to_test <- setdiff(names(balance_df), c("hhid", "hhid_village", "treatment_group"))
vars_to_test
regression_results <- run_regressions(long_data, 'group', 'hhid_village', vars_to_test)
#remotes::install_github("kwb-r/kwb.utils")
#options(repos = c(
#  kwbr = 'https://kwb-r.r-universe.dev',
#  CRAN = 'https://cloud.r-project.org'))
# Download and install kwb.utils in R
#install.packages('kwb.utils')
# install.packages(officer)
# install.packages(r2rtf)
# install.packages(dplyr)
# install.packages(ggplot2)
# install.packages(kwb.utils)
# install.packages(haven)
# install.packages(data.table)
# install.packages(rtf)
# install.packages(tidyverse)
# install.packages(estimatr)
# install.packages(broom)
#install.packages(reshape2)
# install.packages("cobalt")
# install.packages("RCT")
#install.packages("purrr")
#library(reshape2)
#library(officer)
#library(r2rtf)
library(dplyr)
library(readr)
library(tidyr)
#library(ggplot2)
#library(kwb.utils)
library(haven)
library(data.table)
#library(rtf)
library(tidyverse)
library(estimatr)
library(broom)
library(kableExtra)
library(sandwich)
library(lmtest)
#library(cobalt)
# Define the file paths
proj_paths <- list(
projects = "C:/Users/Kateri/Box/NSF Senegal",
alternative_projects = "C:/Users/km978/Box/NSF Senegal"
)
# Check if the Kateri path exists and resolve the project path accordingly
if (file.exists(proj_paths$projects)) {
proj <- kwb.utils::resolve(list(
projects = proj_paths$projects,
p1 = "<projects>/Data_Management/Output/Data_Analysis/Balance_Tables"
))
} else {
proj <- kwb.utils::resolve(list(
projects = proj_paths$alternative_projects,
p1 = "<projects>/Data_Management/Output/Data_Analysis/Balance_Tables"
))
}
file_path_balance_tables_df <- file.path(proj$p1, "baseline_balance_tables_data.dta")
balance_df <- read_dta(file_path_balance_tables_df)
balance_df
#survey_questions <- read_csv(file.path(proj$p1, "Baseline_Survey_Questions.csv"))
#balance_df
# Adding a single categorical variable for household training categories
balance_df <- balance_df %>%
mutate(
# Extract the two middle characters (e.g., 2A) from hhid
group = str_sub(hhid, 3, 4),
# Assign treatment group based on the extracted group value
treatment_group = case_when(
group %in% c("0A", "0B") ~ "Control",
group %in% c("1A", "1B") ~ "Treatment1", # Public health trained
group %in% c("2A", "2B") ~ "Treatment2", # Private benefits trained
group %in% c("3A", "3B") ~ "Treatment3"  # Public and private trained
)
) %>%
select(-group)
#view(balance_df)
# Ensure 'group' is character to avoid conflicts
# balance_df <- balance_df %>%
#   mutate(group = as.character(group))
# Reshape the data
long_data <- balance_df %>%
pivot_longer(
cols = -c(hhid, hhid_village, treatment_group),  # Keep hhid and group as is, pivot all other columns
names_to = "variable",    # Create a column named "variable" for former column names
values_to = "value"       # Store values in a column named "value"
)
#view(long_data)
# View the transformed dat
###################### bring in survey questions to merge ###################################################
long_data <- long_data %>%
rename(group = treatment_group)
long_data
# long_data <- merge(long_data, survey_questions, by = "variable")
#
# view(long_data)
# survey_questions
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     treatment1 = if_else(group %in% c("1A", "1B"), 1, 0), #public health trained
#     treatment2 = if_else(group %in% c("2A", "2B"), 1, 0), # private benefits trained
#     treatment3 = if_else(group %in% c("3A", "3B"), 1, 0) # public_and_private_trained
#   ) #%>%
#   # Drop the 'group' column if it's not needed
#   #select(-group)
#
# view(balance_df)
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     public_health_trained = if_else(group %in% c("1A", "1B"), 1, 0),
#     private_benefits_trained = if_else(group %in% c("2A", "2B"), 1, 0),
#     public_and_private_trained = if_else(group %in% c("3A", "3B"), 1, 0)
#   ) %>%
#   # Drop the 'group' column if it's not needed
#   select(-group)
#
# view(balance_df)
run_regressions <- function(data, treatment_col, village_col, vars_to_test) {
results <- list()
for (var in vars_to_test) {
treatments <- unique(data[[treatment_col]])
treatments <- setdiff(treatments, 'Control')
for (arm in treatments) {
subset <- data %>% filter(.data[[treatment_col]] %in% c('Control', arm) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == arm, 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste('Control vs', arm),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
for (i in 1:(length(treatments) - 1)) {
for (j in (i + 1):length(treatments)) {
subset <- data %>% filter(.data[[treatment_col]] %in% c(treatments[i], treatments[j]) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == treatments[j], 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste(treatments[i], 'vs', treatments[j]),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
}
}
bind_rows(results)
}
vars_to_test <- setdiff(names(balance_df), c("hhid", "hhid_village", "treatment_group"))
regression_results <- run_regressions(long_data, 'group', 'hhid_village', vars_to_test)
summary(long_data)
dim(long_data)
long_data
view(long_data)
vars_to_test <- c("hh_education_skills_1_")
regression_results <- run_regressions(long_data, 'group', 'hhid_village', vars_to_test)
vars_to_test <- setdiff(names(balance_df), c("hhid", "hhid_village", "treatment_group"))
vars_to_test
# Load required libraries
library(dplyr)
library(tidyr)
library(lmtest)
library(sandwich)
# Set seed for reproducibility
set.seed(42)
# Create synthetic long-format data
n <- 200  # Number of households
villages <- 20  # Number of villages
# Generate IDs and groups
hhid <- paste0(rep(1:n, each=5), sprintf('%02d', 1:5))
hhid_village <- sample(LETTERS[1:villages], n*5, replace = TRUE)
group <- sample(c('Control', 'Treatment1', 'Treatment2', 'Treatment3'), n*5, replace = TRUE)
# Generate variable names and values
variables <- rep(c('hh_age_resp', 'hh_gender', 'hh_income', 'hh_education', 'hh_assets'), times = n)
value <- rnorm(n * 5)
# Combine into a long-format dataframe
data <- data.frame(hhid_village, hhid, group, variable = variables, value)
# Function to run regressions and extract t-stats and p-values
run_regressions <- function(data, treatment_col, village_col, vars_to_test) {
results <- list()
for (var in vars_to_test) {
treatments <- unique(data[[treatment_col]])
treatments <- setdiff(treatments, 'Control')
for (arm in treatments) {
subset <- data %>% filter(.data[[treatment_col]] %in% c('Control', arm) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == arm, 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste('Control vs', arm),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
for (i in 1:(length(treatments) - 1)) {
for (j in (i + 1):length(treatments)) {
subset <- data %>% filter(.data[[treatment_col]] %in% c(treatments[i], treatments[j]) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == treatments[j], 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste(treatments[i], 'vs', treatments[j]),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
}
}
bind_rows(results)
}
# Run the regressions
vars_to_test <- unique(data$variable)
regression_results <- run_regressions(data, 'group', 'hhid_village', vars_to_test)
# Convert all columns to character before pivoting
regression_results <- regression_results %>% mutate(across(everything(), as.character))
# Pivot the table to have variables as rows and comparisons as columns
final_table <- regression_results %>%
pivot_wider(names_from = comparison, values_from = c(stat, p))
# Rearrange to stack t-stats and p-values in rows
final_table <- final_table %>%
pivot_longer(cols = -variable, names_to = 'comparison', values_to = 'value') %>%
separate(comparison, into = c('type', 'comparison'), sep = '_', extra = 'merge') %>%
pivot_wider(names_from = comparison, values_from = value)
final_table <- final_table %>%
mutate(across(where(is.numeric), ~ formatC(.x, format = "f", digits = 3))) %>%  # Round and format numeric columns to 2 decimal places
mutate(across(everything(), as.character)) %>%  # Convert all columns to character for manipulation
mutate(across(everything(), ~ ifelse(grepl("p", type),
paste0("(", .x, ")"),
.x)))  # Add parentheses for p.value rows
final_table <- final_table %>%
mutate(
variable = ifelse(type == "(p)", "", variable),
type = ifelse(type == "(p)", "", type)
)
# View final table
print(final_table)
names(balance_df)
vars_to_test <- setdiff(names(balance_df), c("hhid", "hhid_village", "treatment_group"))
vars_to_test
long_data
table(long_data$group)
table(long_data$hhid_village)
long_data$group <- as.factor(long_data$group)
long_data$hhid_village <- as.factor(long_data$hhid_village)
regression_results <- run_regressions(long_data, 'group', 'hhid_village', vars_to_test)
print(unique(subset[[village_col]]))  #
# Adding a single categorical variable for household training categories
balance_df <- balance_df %>%
mutate(
# Extract the two middle characters (e.g., 2A) from hhid
group = str_sub(hhid, 3, 4),
# Assign treatment group based on the extracted group value
treatment_group = case_when(
group %in% c("0A", "0B") ~ "Control",
group %in% c("1A", "1B") ~ "Treatment1", # Public health trained
group %in% c("2A", "2B") ~ "Treatment2", # Private benefits trained
group %in% c("3A", "3B") ~ "Treatment3"  # Public and private trained
)
) %>%
select(-group)
#view(balance_df)
# Ensure 'group' is character to avoid conflicts
# balance_df <- balance_df %>%
#   mutate(group = as.character(group))
# Reshape the data
long_data <- balance_df %>%
pivot_longer(
cols = -c(hhid, hhid_village, treatment_group),  # Keep hhid and group as is, pivot all other columns
names_to = "variable",    # Create a column named "variable" for former column names
values_to = "value"       # Store values in a column named "value"
)
#view(long_data)
# View the transformed dat
###################### bring in survey questions to merge ###################################################
long_data <- long_data %>%
rename(group = treatment_group)
long_data
# long_data <- merge(long_data, survey_questions, by = "variable")
#
# view(long_data)
# survey_questions
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     treatment1 = if_else(group %in% c("1A", "1B"), 1, 0), #public health trained
#     treatment2 = if_else(group %in% c("2A", "2B"), 1, 0), # private benefits trained
#     treatment3 = if_else(group %in% c("3A", "3B"), 1, 0) # public_and_private_trained
#   ) #%>%
#   # Drop the 'group' column if it's not needed
#   #select(-group)
#
# view(balance_df)
# Adding indicator variables for household training categories
# balance_df <- balance_df %>%
#   mutate(
#     # Extract the two middle characters (e.g., 2A) from hhid
#     group = str_sub(hhid, 3, 4),
#
#     # Add indicator variables based on the group value
#     control = if_else(group %in% c("0A", "0B"), 1, 0),
#     public_health_trained = if_else(group %in% c("1A", "1B"), 1, 0),
#     private_benefits_trained = if_else(group %in% c("2A", "2B"), 1, 0),
#     public_and_private_trained = if_else(group %in% c("3A", "3B"), 1, 0)
#   ) %>%
#   # Drop the 'group' column if it's not needed
#   select(-group)
#
# view(balance_df)
run_regressions <- function(data, treatment_col, village_col, vars_to_test) {
results <- list()
for (var in vars_to_test) {
treatments <- unique(data[[treatment_col]])
treatments <- setdiff(treatments, 'Control')
for (arm in treatments) {
subset <- data %>% filter(.data[[treatment_col]] %in% c('Control', arm) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == arm, 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste('Control vs', arm),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
for (i in 1:(length(treatments) - 1)) {
for (j in (i + 1):length(treatments)) {
subset <- data %>% filter(.data[[treatment_col]] %in% c(treatments[i], treatments[j]) & variable == var)
subset$treat <- ifelse(subset[[treatment_col]] == treatments[j], 1, 0)
model <- lm(value ~ treat, data = subset)
clustered_se <- coeftest(model, vcov = vcovCL(model, cluster = subset[[village_col]]))
results <- append(results, list(data.frame(variable = var, comparison = paste(treatments[i], 'vs', treatments[j]),
stat = round(clustered_se[2, 3], 2),
p = round(clustered_se[2, 4], 2))))
}
}
}
bind_rows(results)
}
###issue with rounding - need to first change into long format with everythingas doubles then stack pvalues, THEN change to characters to add parenthesis
#names(balance_df)
vars_to_test <- setdiff(names(balance_df), c("hhid", "hhid_village", "treatment_group"))
#vars_to_test <- c("hh_education_skills_1_")
regression_results <- run_regressions(long_data, 'group', 'hhid_village', vars_to_test)
