---
title: "Parasitological_Logistic_Regression_Analysis"
output: html_document
date: "2024-11-18"
---

#BEGIN HERE - load packages

```{r}
#install.packages("ggmosaic")
#install.packages("vcd")
#install.packages("stargazer")
#install.packages("MASS")  
#install.packages("pscl")  
#install.packages("sandwich")

library(vcd)
library(ggmosaic)
library(officer)
library(r2rtf)
library(dplyr)
library(ggplot2)
library(kwb.utils)
library(haven)
library(data.table)
library(rtf)
library(tidyverse)
library(estimatr)
library(broom)
#library(MASS)       
library(stats)
library(stargazer)
library(pscl)
library(sandwich)

```

#Load file paths

```{r}
# Define the file paths
proj_paths <- list(
  projects = "C:/Users/Kateri/Box/NSF Senegal",
  alternative_projects = "C:/Users/km978/Box/NSF Senegal"
)

# Check if the Kateri path exists and resolve the project path accordingly
if (file.exists(proj_paths$projects)) {
  proj <- kwb.utils::resolve(list(
    projects = proj_paths$projects,
    p1 = "<projects>/Data Management/_PartnerData/Child infection dataframe/Dataframe"
  ))
} else {
  proj <- kwb.utils::resolve(list(
    projects = proj_paths$alternative_projects,
    p1 = "<projects>/Data Management/_PartnerData/Child infection dataframe/Dataframe"
  ))
}

file_path_infection_df <- file.path(proj$p1, "child_infection_dataframe_features.dta")
infection_df <- read_dta(file_path_infection_df)


```

## Filter df

```{r}

matched_only_df <- infection_df %>%
  filter(match_score != "")

```

#Create relevant variables

```{r}


# Calculate egg counts
matched_only_df <- matched_only_df %>%
  # 1) Calculate S. haematobium egg count
  mutate(
    sh_egg_count = if_else(fu_p1 > 0, fu_p1, fu_p2),  # max of fu_p1 and fu_p2, only use fu_p2 if fu_p1 is zero

    #  2) Calculate S. mansoni egg count
    # Calculate average of each pass
    p1_avg = (p1_kato1_k1_pg + p1_kato2_k2_peg) / 2,
    p2_avg = (p2_kato1_k1_epg + p2_kato2_k2_epg) / 2,

    # Only calculate p2_avg if p1_avg is zero, then take the maximum of p1_avg and p2_avg
    sm_egg_count = if_else(p1_avg > 0, p1_avg, p2_avg)
  )# %>%

#Change variables to factors 

# matched_only_df <- matched_only_df %>%
#   mutate(
#     health_5_3_2_ = as.factor(health_5_3_2_), 
#     health_5_5_ = as.factor(health_5_5_),
#     health_5_6_ = as.factor(health_5_6_),
#     health_5_8_ = as.factor(health_5_8_),
#     health_5_9_ = as.factor(health_5_9_),
#     health_5_10_ = as.factor(health_5_10_)
# )

```

#EDA

```{r}
str(matched_only_df$sm_egg_count)
table(matched_only_df$sm_egg_count)
summary(matched_only_df$sm_egg_count)
```

###categorical 
```{r}
# var_names <- c("health_5_3_2_", "health_5_4_", "health_5_5_", "health_5_6_", "health_5_8_", "health_5_9_", "hh_gender_", "hh_ethnicity_", "hh_12_1_", "hh_12_2_", "hh_12_3_",  "hh_12_4_", "hh_12_5_", "hh_12_6_", "hh_12_7_", "hh_12_8_", "hh_31_", "hh_33_", "hh_37_", "living_01", "living_02", "living_04", "wealthindex")
# 
# matched_only_df_summary <- matched_only_df %>%
#    dplyr::select(all_of(var_names))
#Categorical function

# Function to calculate summary statistics for a single categorical vector
categ_func_l <- function(value_l) {
  # N = Total number of non-empty, non-NA observations (including -9s but excluding true NAs/empty cells)
  N <- sum(!is.na(value_l) & value_l != "")
  
  # Remove NAs and invalid values (-9 in this example)
  valid_value_l <- value_l[!is.na(value_l) & value_l != -9]
  
  # Calculate frequency and proportion for valid responses
  freq_table_l <- table(valid_value_l)
  proportions_l <- round(freq_table_l / length(valid_value_l), 2)
  
  # Calculate the proportion of -9s and NAs
  prop_na_l <- round(sum(value_l == -9, na.rm = TRUE) / N, 2)
  
  # Create a data frame with the summary
  categorical_data_l <- data.frame(
    Value = names(freq_table_l),
    N = N,  # Total number of observations
    Frequency = as.vector(freq_table_l),  # Frequency of valid responses
    Proportion = as.vector(proportions_l),  # Proportion of valid responses
    prop_na = prop_na_l  # Proportion of -9s/NAs
  )
  
  return(categorical_data_l)
}

# Function to summarize multiple categorical variables by prefix
categ_summary_l <- function(data_l, prefixes_l) {
  summaries_l <- lapply(prefixes_l, function(prefix_l) {
    variable_data_l <- data_l %>%
      select(starts_with(prefix_l))
    
    # Pull the 'value' column and pass to categ_func_l
    value_l <- variable_data_l[[1]]
    summary_categ_l <- categ_func_l(value_l)
    summary_categ_l$Variable_l <- prefix_l  # Assign the prefix as the variable name
    return(summary_categ_l)
  })
  
  categ_sum_set_l <- bind_rows(summaries_l)
  return(categ_sum_set_l)
}


```



```{r}
setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")
install.packages("gt")
library(gt)

prefixes_categ <- c("hh_31_", "hh_33_", "living_01", "living_02", "living_03", "living_04")


output_categ <- as.data.frame(categ_summary_l(matched_only_df, prefixes_categ))
rownames(output_categ) <- NULL


output_categ_gt <- gt(output_categ)

output_categ_gt <- output_categ_gt %>%
  tab_header(
    title = "Categorical Stats"
  )


gtsave(output_categ_gt, "output_categ_clean_table.tex", path = "C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")
```


###binary

```{r}
# Function to calculate summary statistics for a single vector (variable)
binary_func_l <- function(value) {

  # Calculate summary statistics for 0s and 1s
  binary_stats_l <- data.frame(
    N = round(sum(!is.na(value)), 2),
    mean = round(mean(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    sd = round(sd(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    prop_na = round(sum(value == -9, na.rm = TRUE) / sum(!is.na(value)), 2)
  )
  
  return(binary_stats_l)
}

binary_summary_l <- function(baseline_data, prefixes) {
  # Loop over each prefix
  summaries_binary_l <- lapply(prefixes, function(prefix) {
    # Select the column that matches the prefix
    selected_data <- baseline_data %>%
      select(starts_with(prefix))
    
    # Pull the column values and pass to binary_func_l
    value <- selected_data[[1]]
    summary_stats <- binary_func_l(value)
    
    # Add the prefix (variable name) to the summary
    summary_stats$variable <- prefix
    
    return(summary_stats)
  })
  
  binary_sum_set_l <- bind_rows(summaries_binary_l)
  return(binary_sum_set_l)
}

```



```{r}
setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")

prefixes_binary <- c("health_5_3_2_", "health_5_5_", "health_5_6_", "health_5_8_", "health_5_9_", "hh_gender_", "hh_12_1_", "hh_12_2_", "hh_12_3_", "hh_12_4_", "hh_12_5_", "hh_12_6_", "hh_12_7_",  "hh_12_8_")

# output_binary <- as.data.frame(categ_summary_l(matched_only_df, prefixes_binary))
# rownames(output_binary) <- NULL

output_binary <- binary_summary_l(matched_only_df, prefixes_binary)

# Use stargazer for the formatted output
# stargazer(output_binary,
#           type = "text",
#           style = "aer",
#            summary = FALSE,
#             rownames = NULL,
#           single.row = FALSE,
#           order = NULL,
#           out = "binary_var.tex")

output_binary_gt <- gt(output_binary)

output_binary_gt <- output_binary_gt %>%
  tab_header(
    title = "Binary Stats"
  )


gtsave(output_binary_gt, "output_binary_clean_table.tex", path = "C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")


```

###numerical 


```{r}

# Function to calculate summary statistics for a single numeric vector
numerical_summary_func_l <- function(value) {
  
  # Calculate summary statistics for numeric variables
  numerical_stats_l <- data.frame(
    N = round(sum(!is.na(value)), 2),
    min = round(min(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    mean = round(mean(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    #max = round(max(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    max = sprintf("%.2f", max(ifelse(value == -9, NA, value), na.rm = TRUE),2),
    sd = round(sd(ifelse(value == -9, NA, value), na.rm = TRUE), 2),
    prop_na = round(sum(value == -9, na.rm = TRUE) / sum(!is.na(value)), 2)
  )
  
  return(numerical_stats_l)
}

# Function to summarize multiple sets of numeric variables by prefix
numerical_summary_l <- function(baseline_data, prefixes) {
  # Loop over each prefix
  summaries_numerical_l <- lapply(prefixes, function(prefix) {
    # Select the column that matches the prefix
    numerical_data_l <- baseline_data %>%
      select(starts_with(prefix))
    
    # Pull the column values and pass to numerical_summary_func_l
    value <- numerical_data_l[[1]]
    numerical_summary_stats <- numerical_summary_func_l(value)
    
    # Add the prefix (variable name) to the summary
    numerical_summary_stats$variable <- prefix
    
    return(numerical_summary_stats)
  })
  
  # Combine the summaries into a single data frame
  numerical_sum_set_l <- bind_rows(summaries_numerical_l)
  return(numerical_sum_set_l)
}


```


```{r}
setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")

prefixes_numerical <- c("wealthindex", "health_5_4_", "hh_age_")

# output_binary <- as.data.frame(categ_summary_l(matched_only_df, prefixes_binary))
# rownames(output_binary) <- NULL
# 
output_numerical <- numerical_summary_l(matched_only_df, prefixes_numerical)
# 
# # Use stargazer for the formatted output
# stargazer(output_numerical,
#           type = "text",
#           style = "aer",
#            summary = FALSE,
#             rownames = NULL,
#           single.row = FALSE,
#           order = NULL,
#           out = "numerical_var.tex")

output_numerical_gt <- gt(output_numerical)

output_numerical_gt <- output_numerical_gt %>%
  tab_header(
    title = "Numerical Stats"
  )


gtsave(output_numerical_gt, "output_numerical_clean_table.tex", path = "C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")


```




```{r}
#MAYBE do this lol
###rename vars for clarity 

# matched_only_df <- matched_only_df %>%
#   rename(health_perception = health_5_3_2_,
#          health_sch = health_5_4_,
#          health_med = health_5_5_,
#          health_diag = health_5_6_,
#          
#                   )

```


#Variable notes:

-   health_5_3_2 = illness suffered? \_2 = chose Bilharzia
-   health_5_4 = how many days of school missed
-   health_5_5 = Has he/she received medication for schistosomiasis in the past 12 months?
-   health_5_6 = Ever diagnosed w/ schisto?
-   health_5_8 = blood in urine past 12 months?
-   health_5_9 = blood in stool past 12 months?
-   hh_11 = which water source
-   hh_12 = why person spent time near water source
-   hh_33 = performace in class
-   hh_37 = had illness last 12 months
-   living_01 = source of drinking water
-   living_02 = is the water treated
-   living_03 = if so, how
-   living_04 = main type of toilet used


health_5_3_2_ = What type of illness or injury did he/she suffer from? (answer choice is Bilharzia) Binary
health_5_4_ = How many days did he/she miss work/school due to illness or injury in the past month? Numeric

##stargazer package reminders lol

output of regression table
 stargazer(production_reg,
           title ="Precision",
           type = "text",
           report = "vc*s",
           #model.numbers=FALSE,
           covariate.labels = c("Heat", "Male", "Time", "Heat X Time ", "Height", "Height (Missing)"),
           dep.var.labels = "",
           column.labels = regression_names,
           no.space = TRUE,
           column.sep.width = "3pt",
           se = production_reg_pvals,
           p = production_reg_pvals,
           omit.stat = c("f", "adj.rsq", "ser")
           omit = c("height_reg", "height_reg_miss")

#Bivariate Logistic regression 01

```{r}

setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")
# Specify the formula for logistic regression
formula_01 <- sh_inf ~ health_5_3_2_ + health_5_4_ 

# Run the logistic regression
logit_model_01 <- glm(formula_01, data = matched_only_df, family = binomial)

#covariate_labels <- c("Perception", "Recently infected") 
# Calculate McFadden's pseudo R^2

# Calculate Pseudo R^2 using the pscl package
pseudo_r2 <- pR2(logit_model_01)["McFadden"]
pseudo_r2
# Calculate BIC
bic_value <- BIC(logit_model_01)

# Display the regression summary with additional statistics
# stargazer(logit_model_01,  
#           covariate.labels = c("Percieved infection", "Missed school days"),
#           type = "text", 
#           digit.separator = "",
#           no.space = TRUE,
#           column.sep.width = "3pt",
#           add.lines = list(c("BIC", round(bic_value, 2))),
#           out = "logit_model_01_table.tex")

logit_model_01_done <- stargazer(logit_model_01,  
          covariate.labels = c("Percieved infection", "Missed school days"),
          type = "text", 
          digit.separator = "",
          no.space = TRUE,
          column.sep.width = "3pt",
          add.lines = list(c("Pseudo R^2", pseudo_r2)), 
              c("BIC", round(bic_value, 2))
          )
          

cat(logit_model_01_done, sep = '\n', file = "logit_model_01_table.tex")

# pseudo_r2 <- pR2(logit_model_01)["McFadden"]
# 
# # Calculate BIC
# bic_value <- BIC(logit_model_01)
# 
# 
# 
# # Display summary of the model
# stargazer(logit_model_01,  
#           covariate.labels = c("Percieved infection", "Missed school days"),
#           #dep.var.labels = "",
#           type = "text", 
#           digit.separator = "",
#           no.space = TRUE,
#           column.sep.width = "3pt",
#           add.lines = pseudo_r2, 
#           add.lines = bic_value,
#           # add.lines = list(c("Pseudo R^2", round(pseudo_r2, 4)), 
#           #                  c("BIC", round(bic_value, 2))),
#           out = "logit_model_01_table.tex")  # Omit some statistics


# Extract coefficients
coefficients_01 <- coef(logit_model_01)

# Calculate odds ratios
odds_ratios_01 <- exp(coefficients_01)
odds_ratios_01
# Display odds ratios

# Display odds ratios in long format for better readability 
odds_ratios_long_01 <- data.frame(
  Variable = c("Intercept", 
               "Perceived infection", 
               "Missed school days"),
  Odds_Ratio = odds_ratios_01
)

# Use stargazer for a "long" table
stargazer(odds_ratios_long_01,
          summary = FALSE,   # Suppresses summary statistics
          type = "latex",
          rownames = FALSE, #Removes row numbers
          out = "odds_ratios_01.tex")

# Calculate confidence intervals for coefficients
conf_int_01 <- confint(logit_model_01)

# Exponentiate to get confidence intervals for odds ratios
conf_int_odds_ratios_01 <- exp(conf_int_01)

# Display odds ratios with confidence intervals
CI_odds_01 <- data.frame(Odds_Ratio = odds_ratios_01, 
           CI_Lower = conf_int_odds_ratios_01[, 1], 
           CI_Upper = conf_int_odds_ratios_01[, 2])

stargazer(CI_odds_01,
          type = "latex",
          out = "CI_odds_01.tex")

```


#Bivariate Logistic regression 02



```{r}
setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")

# Specify the formula for logistic regression
formula_02 <- sh_inf ~ health_5_3_2_ + health_5_4_ + health_5_5_ + health_5_6_

# Run the logistic regression
logit_model_02 <- glm(formula, data = matched_only_df, family = binomial)

#covariate_labels <- c("Perception", "Recently infected") 

# Display summary of the model
stargazer(logit_model_02,  
          covariate.labels = c("Percieved infection", "Missed school days", "Recived medication", "Ever diagnosed with Bilharzia"),
          #dep.var.labels = "",
          type = "text", 
          digit.separator = "",
          no.space = TRUE,
          column.sep.width = "3pt",
          out = "logit_model_02_table.tex")  # Omit some statistics


# Extract coefficients
coefficients_02 <- coef(logit_model_02)

# Calculate odds ratios
odds_ratios_02 <- exp(coefficients_02)

# Display odds ratios in long format for better readability 
odds_ratios_long_02 <- data.frame(
  Variable = c("Intercept", 
               "Perceived infection", 
               "Missed school days", 
               "Received medication", 
               "Ever diagnosed with Bilharzia"),
  Odds_Ratio = odds_ratios_02
)

# Use stargazer for a "long" table
stargazer(odds_ratios_long_02,
          summary = FALSE,   # Suppresses summary statistics
          type = "latex",
          rownames = FALSE, #Removes row numbers
          out = "odds_ratios_02.tex")

# Calculate confidence intervals for coefficients
conf_int <- confint(logit_model_02)

# Exponentiate to get confidence intervals for odds ratios
conf_int_odds_ratios_02 <- exp(conf_int)

# Display odds ratios with confidence intervals
CI_odds_02 <- data.frame(Odds_Ratio = odds_ratios_02, 
           CI_Lower = conf_int_odds_ratios_02[, 1], 
           CI_Upper = conf_int_odds_ratios_02[, 2])

stargazer(CI_odds_02,
          type = "latex",
          out = "CI_odds_02.tex")
```



#Bivariate Logistic regression 03

```{r}
#setwd("C:/Users/Kateri/Downloads/SenegalGIT/NSF-Senegal/Latex Output")
   setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")

# Specify the formula for logistic regression

# Replace all 2s in the variable health_5_8_ with NAs
# Replace all 2s in the variable health_5_8_ with NAs directly in the dataframe
matched_only_df$health_5_8_ <- ifelse(matched_only_df$health_5_8_ == 2, NA, matched_only_df$health_5_8_)





formula_03 <- sh_inf ~  health_5_3_2_ + health_5_4_ + health_5_5_ + health_5_6_ + health_5_8_ + health_5_9_ 

# Run the logistic regression
logit_model_03 <- glm(formula_03, data = matched_only_df, family = binomial)

covariate_labels_03 <- c("Percieved infection", "Missed school days", "Recived medication", "Ever diagnosed with Bilharzia", "Blood in urine", "Blood in stool")
#view(matched_only_df)

# Display summary of the model
stargazer(logit_model_03,  
          covariate.labels = covariate_labels_03,
          #dep.var.labels = "",
          type = "latex", 
          digit.separator = "",
          no.space = TRUE,
          column.sep.width = "3pt",
          out = "logit_model_03_table.tex")  # Omit some statistics


# Extract coefficients
coefficients_03 <- coef(logit_model_03)

# Calculate odds ratios
odds_ratios_03 <- exp(coefficients_03)
odds_ratios_03
#Display odds ratios in long format for better readability
odds_ratios_long_03 <- data.frame(
  Variable = c("Intercept", 
               "Percieved infection",
               "Missed school days",
               "Recived medication", 
               "Ever diagnosed with Bilharzia", 
               "Blood in urine",
               "Blood in stool"),
  Odds_Ratio = odds_ratios_03
)

# Use stargazer for a "long" table
stargazer(odds_ratios_long_03,
          summary = FALSE,   # Suppresses summary statistics
          type = "latex",
          rownames = FALSE, #Removes row numbers
          out = "odds_ratios_03.tex")

# Calculate confidence intervals for coefficients
conf_int_03 <- confint(logit_model_03)

# Exponentiate to get confidence intervals for odds ratios
conf_int_odds_ratios_03 <- exp(conf_int_03)

# Display odds ratios with confidence intervals
CI_odds_03 <- data.frame(Odds_Ratio = odds_ratios_03, 
           CI_Lower = conf_int_odds_ratios_03[, 1], 
           CI_Upper = conf_int_odds_ratios_03[, 2])

stargazer(CI_odds_03,
          type = "latex",
          out = "CI_odds_03.tex")
```



#Bivariate Logistic regression 04


```{r}
# hh_12_7_ + hh_31_ + hh_33_ + hh_37_ + living_01 + living_02 + living_03 + living_04 + wealthindex 
```




```{r}
setwd("C:/Users/km978/Downloads/SenegalGIT/NSF-Senegal/Latex")

# Specify the formula for logistic regression
formula_04 <- sh_inf ~  health_5_3_2_ + health_5_4_ + health_5_5_ + health_5_6_ + health_5_8_ + health_5_9_ + hh_gender_ + hh_ethnicity_ + hh_12_1_ + hh_12_2_ + hh_12_3_ + hh_12_4_ + hh_12_5_ + hh_12_6_ + hh_12_7_ + hh_12_8_ + hh_31_ + hh_33_ + hh_37_ + living_01 + living_02 + living_04  + wealthindex
# hh_11_ = "Type of surface water", maybe bring this back???
# Run the logistic regression
logit_model_04 <- glm(formula_04, data = matched_only_df, family = binomial)
logit_model_04

covariate_labels_04 <- c("Percieved infection", "Missed school days", "Recived medication", "Ever diagnosed with Bilharzia", "Blood in urine", "Blood in stool", "Gender", "Ethnicity", "Fetch water for HH", "water for Livestock", "Fetch water for ag", "Wash clothes", "Do the dishes", "harvest aquatic veg", "Swim/bathe", "Play", "Grade achieved in 2022/2023", "Academic performance", "School missed", "Source of drinking water supply", "Water treated?", "Type of toilet", "wealth index")

# Display summary of the model
stargazer(logit_model_04,  
          covariate.labels = covariate_labels_04,
          #dep.var.labels = "",
          type = "latex", 
          digit.separator = "",
          no.space = TRUE,
          column.sep.width = "3pt",
          out = "logit_model_04_table.tex")  # Omit some statistics


# Extract coefficients
coefficients_04 <- coef(logit_model_04)

# Calculate odds ratios
odds_ratios_04 <- exp(coefficients_04)
odds_ratios_04
#Display odds ratios in long format for better readability
odds_ratios_long_04 <- data.frame(
  Variable = c("Intercept", "Percieved infection", "Missed school days", "Recived medication", "Ever diagnosed with Bilharzia", "Blood in urine","Blood in stool", "Gender", "Ethnicity", "Fetch water for HH", "water for Livestock", "Fetch water for ag", "Wash clothes", "Do the dishes", "harvest aquatic veg", "Swim/bathe", "Play", "Grade achieved in 2022/2023", "Academic performance", "School missed", "Source of drinking water supply", "Water treated?", "Type of toilet", "wealth index"),
  Odds_Ratio = odds_ratios_04
)

# Use stargazer for a "long" table
stargazer(odds_ratios_long_04,
          summary = FALSE,   # Suppresses summary statistics
          type = "latex",
          rownames = FALSE, #Removes row numbers
          out = "odds_ratios_04.tex")

# Calculate confidence intervals for coefficients
conf_int_04 <- confint(logit_model_04)

# Exponentiate to get confidence intervals for odds ratios
conf_int_odds_ratios_04 <- exp(conf_int_04)

# Display odds ratios with confidence intervals
CI_odds_04 <- data.frame(Odds_Ratio = odds_ratios_04, 
           CI_Lower = conf_int_odds_ratios_04[, 1], 
           CI_Upper = conf_int_odds_ratios_04[, 2])

stargazer(CI_odds_04,
          type = "latex",
          out = "CI_odds_04.tex")
```













