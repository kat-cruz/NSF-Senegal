---
title: "Balance_table_test"
author: "Kateri Mouawad"
date: "2025-02-12"
output: html_document
---

```{r}

# Load necessary libraries
library(dplyr)
library(tidyr)
library(broom)


```


```{r}


# Set seed for reproducibility
set.seed(123)

# Generate synthetic data (already in long format)
# Generate synthetic data (already in long format)
n <- 200  # Number of households
balance_test_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)

# Function to compute summary statistics by group (means and SDs)
compute_summary_stats <- function(df, vars) {
  df %>%
    filter(variable %in% vars) %>%
    group_by(group, variable) %>%
    summarise(mean = mean(value, na.rm = TRUE),
              sd = sd(value, na.rm = TRUE),
              n = n(), .groups = "drop")
}

# Function to run t-tests for pairwise comparisons
run_t_tests <- function(df, vars) {
  t_test_results <- lapply(vars, function(var) {
    # T-tests: Control vs. each treatment arm
    control_vs_treatment <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    
    # Treatment comparisons: make sure there's only two groups
    treatment_comparisons <- lapply(c("Treatment1", "Treatment2", "Treatment3"), function(treatment_group) {
      # Check if both groups have data
      treatment_data <- df %>% filter(group %in% c("Treatment1", treatment_group), variable == var)
      
      if (n_distinct(treatment_data$group) == 2) {
        return(t.test(value ~ group, data = treatment_data))
      } else {
        return(NULL)  # Skip the comparison if there's not exactly 2 groups
      }
    })
    
    # Return t-test results
    list(
      control_vs_treatment = control_vs_treatment,
      treatment_comparisons = treatment_comparisons
    )
  })
  
  return(t_test_results)
}

# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Compute summary statistics for all variables
summary_stats <- compute_summary_stats(balance_test_df, vars_to_test)

# Run t-tests for each variable
t_test_results <- run_t_tests(balance_test_df, vars_to_test)

# Print the summary stats
print(summary_stats)

# Print the t-test results
print(t_test_results)

```


```{r}
# # Load necessary libraries
# library(dplyr)
# library(tidyr)
# library(broom)

# Set seed for reproducibility
set.seed(123)

# Generate synthetic data (already in long format)
n <- 200  # Number of households
balance_test_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)

# Function to compute summary statistics by group (means and SDs)
compute_summary_stats <- function(df, vars) {
  df %>%
    filter(variable %in% vars) %>%
    group_by(group, variable) %>%
    summarise(mean = mean(value, na.rm = TRUE),
              sd = sd(value, na.rm = TRUE),
              n = n(), .groups = "drop")
}

# Function to run t-tests for pairwise comparisons
run_t_tests <- function(df, vars) {
  t_test_results <- lapply(vars, function(var) {
    # T-tests: Control vs. each treatment arm
    control_vs_treatment <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    
    # Treatment comparisons: make sure there's only two groups
    treatment_comparisons <- lapply(c("Treatment1", "Treatment2", "Treatment3"), function(treatment_group) {
      # Check if both groups have data
      treatment_data <- df %>% filter(group %in% c("Treatment1", treatment_group), variable == var)
      
      if (n_distinct(treatment_data$group) == 2) {
        return(t.test(value ~ group, data = treatment_data))
      } else {
        return(NULL)  # Skip the comparison if there's not exactly 2 groups
      }
    })
    
    # Return t-test results
    list(
      control_vs_treatment = control_vs_treatment,
      treatment_comparisons = treatment_comparisons
    )
  })
  
  return(t_test_results)
}

# Function to tidy t-test results into a table
tidy_t_tests <- function(t_test_results, vars) {
  results <- lapply(seq_along(t_test_results), function(i) {
    # Extract results for each variable
    var <- vars[i]
    
    # Control vs Treatment t-test results
    control_vs_treatment <- tidy(t_test_results[[i]]$control_vs_treatment) %>%
      mutate(variable = var, comparison = "Control vs Treatment1")
    
    # Pairwise treatment comparisons
    treatment_comparisons <- bind_rows(lapply(1:3, function(j) {
      treatment_result <- t_test_results[[i]]$treatment_comparisons[[j]]
      
      if (!is.null(treatment_result)) {
        tidy(treatment_result) %>%
          mutate(variable = var, comparison = paste("Treatment", j, "vs Treatment", j+1))
      } else {
        NULL
      }
    }))
    
    # Combine control vs treatment and pairwise treatment comparisons
    bind_rows(control_vs_treatment, treatment_comparisons)
  })
  
  # Combine results for all variables into one data frame
  bind_rows(results)
}

# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Compute summary statistics for all variables
summary_stats <- compute_summary_stats(balance_test_df, vars_to_test)

# Run t-tests for each variable
t_test_results <- run_t_tests(balance_test_df, vars_to_test)

# Create a tidy table from the t-test results
tidy_results <- tidy_t_tests(t_test_results, vars_to_test)

# Print the summary stats
print(summary_stats)

# Print the tidy t-test results
print(tidy_results)

```

```{r}
# Set seed for reproducibility
set.seed(123)

# Generate synthetic data
n <- 200  # Number of households
balance_test_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)

# Compute summary statistics
summary_stats <- balance_test_df %>%
  group_by(variable, group) %>%
  summarise(mean = mean(value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = group, values_from = mean)

# Function to run t-tests and store results
run_t_tests <- function(df, vars) {
  results <- list()
  
  for (var in vars) {
    # Control vs. each treatment
    results[[var]] <- list()
    results[[var]][["Control vs Treatment1"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    results[[var]][["Control vs Treatment2"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment2"), variable == var))
    results[[var]][["Control vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment3"), variable == var))
    
    # Treatment pairwise comparisons
    results[[var]][["Treatment1 vs Treatment2"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment1", "Treatment2"), variable == var))
    results[[var]][["Treatment1 vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment1", "Treatment3"), variable == var))
    results[[var]][["Treatment2 vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment2", "Treatment3"), variable == var))
  }
  
  return(results)
}

# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Run t-tests
t_test_results <- run_t_tests(balance_test_df, vars_to_test)

# Convert t-test results into a tidy format
tidy_results <- lapply(names(t_test_results), function(var) {
  bind_rows(lapply(names(t_test_results[[var]]), function(comp) {
    tidy(t_test_results[[var]][[comp]]) %>%
      mutate(variable = var, comparison = comp)
  }))
}) %>%
  bind_rows() %>%
  select(variable, comparison, estimate, p.value) %>%
  pivot_wider(names_from = comparison, values_from = c(estimate, p.value))

# Combine summary statistics with test results into the desired format
final_table <- summary_stats %>%
  left_join(tidy_results, by = "variable") %>%
  arrange(variable)

# Print final table
print(final_table, n = Inf)
```



```{r}

# Load necessary libraries
# library(dplyr)
# library(tidyr)
# library(broom)

# Set seed for reproducibility
set.seed(123)

# Generate synthetic data
n <- 200  # Number of households
balance_test_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)
balance_test_df
summary_stats <- balance_test_df %>%
  group_by(variable, group) %>%
  summarise(mean = mean(value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = group, values_from = mean) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

# Function to run t-tests and store results
run_t_tests <- function(df, vars) {
  results <- list()
  
  for (var in vars) {
    # Control vs. each treatment
    results[[var]] <- list()
    results[[var]][["Control vs Treatment1"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    results[[var]][["Control vs Treatment2"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment2"), variable == var))
    results[[var]][["Control vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment3"), variable == var))
    
    # Treatment pairwise comparisons
    results[[var]][["Treatment1 vs Treatment2"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment1", "Treatment2"), variable == var))
    results[[var]][["Treatment1 vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment1", "Treatment3"), variable == var))
    results[[var]][["Treatment2 vs Treatment3"]] <- t.test(value ~ group, data = df %>% filter(group %in% c("Treatment2", "Treatment3"), variable == var))
  }
  
  return(results)
}

balance_test_df
# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Run t-tests
t_test_results <- run_t_tests(balance_test_df, vars_to_test)
t_test_results
# Convert t-test results into a tidy format
# tidy_results <- lapply(names(t_test_results), function(var) {
#   bind_rows(lapply(names(t_test_results[[var]]), function(comp) {
#     tidy(t_test_results[[var]][[comp]]) %>%
#       mutate(variable = var, comparison = comp)
#   }))
# }) %>%
#   bind_rows() %>%
#   select(variable, comparison, estimate, p.value) %>%
#   pivot_wider(names_from = comparison, values_from = c(estimate, p.value))
# tidy_results

tidy_results <- lapply(names(t_test_results), function(var) {
  bind_rows(lapply(names(t_test_results[[var]]), function(comp) {
    tidy(t_test_results[[var]][[comp]]) %>%
      mutate(variable = var, comparison = comp)
  }))
}) %>%
  bind_rows() %>%
  select(variable, comparison, estimate, p.value) %>%
  mutate(across(c(estimate, p.value), ~ round(.x, 2))) %>%
  pivot_wider(names_from = comparison, values_from = c(estimate, p.value))

# # Reshape the data for the final table: combine estimates and p-values
final_table <- summary_stats %>%
  left_join(tidy_results, by = "variable") %>%
  arrange(variable) %>%
  select(variable, Control, contains("estimate"), contains("p.value")) %>%
  pivot_longer(cols = starts_with("estimate_") | starts_with("p.value_"),
               names_to = c("comparison", "stat"), names_pattern = "(.*)_(.*)", values_to = "value") %>%
  pivot_wider(names_from = stat, values_from = value) %>%  # Separate estimates and p-values
  mutate(across(contains("estimate"), ~ paste0(.x, " (",
                                               round(get(gsub("estimate", "p.value", cur_column())), 3), ")"),
                .names = "{.col}_formatted")) %>%
  select(-contains("p.value"), -contains("estimate"))

# Add parentheses around all values in rows where comparison = "p.value"
final_table <- final_table %>%
  mutate(across(where(is.numeric), ~ formatC(.x, format = "f", digits = 2))) %>%  # Round and format numeric columns to 2 decimal places
  mutate(across(everything(), as.character)) %>%  # Convert all columns to character for manipulation
  mutate(across(everything(), ~ ifelse(grepl("p.value", comparison), 
                                       paste0("(", .x, ")"), 
                                       .x)))  # Add parentheses for p.value rows
final_table <- final_table %>%
  mutate(
    variable = ifelse(comparison == "(p.value)", "", variable),
    comparison = ifelse(comparison == "(p.value)", "", comparison)
  ) %>%
select(-"comparison", -"Control")


 final_table
# Print final table
#print(final_table, n = Inf)

```









