---
title: "Balance_table_test"
author: "Kateri Mouawad"
date: "2025-02-12"
output: html_document
---

```{r}

library(dplyr)
library(cobalt)

```


```{r}

# Load necessary libraries
library(dplyr)
library(tidyr)
library(broom)
# Set seed for reproducibility
set.seed(123)

# Generate synthetic data (already in long format)
# Generate synthetic data (already in long format)
n <- 200  # Number of households
balance_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)

# Function to compute summary statistics by group (means and SDs)
compute_summary_stats <- function(df, vars) {
  df %>%
    filter(variable %in% vars) %>%
    group_by(group, variable) %>%
    summarise(mean = mean(value, na.rm = TRUE),
              sd = sd(value, na.rm = TRUE),
              n = n(), .groups = "drop")
}

# Function to run t-tests for pairwise comparisons
run_t_tests <- function(df, vars) {
  t_test_results <- lapply(vars, function(var) {
    # T-tests: Control vs. each treatment arm
    control_vs_treatment <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    
    # Treatment comparisons: make sure there's only two groups
    treatment_comparisons <- lapply(c("Treatment1", "Treatment2", "Treatment3"), function(treatment_group) {
      # Check if both groups have data
      treatment_data <- df %>% filter(group %in% c("Treatment1", treatment_group), variable == var)
      
      if (n_distinct(treatment_data$group) == 2) {
        return(t.test(value ~ group, data = treatment_data))
      } else {
        return(NULL)  # Skip the comparison if there's not exactly 2 groups
      }
    })
    
    # Return t-test results
    list(
      control_vs_treatment = control_vs_treatment,
      treatment_comparisons = treatment_comparisons
    )
  })
  
  return(t_test_results)
}

# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Compute summary statistics for all variables
summary_stats <- compute_summary_stats(balance_df, vars_to_test)

# Run t-tests for each variable
t_test_results <- run_t_tests(balance_df, vars_to_test)

# Print the summary stats
print(summary_stats)

# Print the t-test results
print(t_test_results)

```
```{r}
# # Load necessary libraries
# library(dplyr)
# library(tidyr)
# library(broom)

# Set seed for reproducibility
set.seed(123)

# Generate synthetic data (already in long format)
n <- 200  # Number of households
balance_df <- data.frame(
  hhid = rep(1:n, each = 3),
  group = rep(c("Control", "Treatment1", "Treatment2", "Treatment3"), n),
  variable = rep(c("hh_08", "hh_09", "hh_10"), each = n),
  value = c(rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3),
            rnorm(n, mean = 0.5, sd = 0.1),
            rnorm(n, mean = 1.5, sd = 0.2),
            rnorm(n, mean = 2.5, sd = 0.3)
  )
)

# Function to compute summary statistics by group (means and SDs)
compute_summary_stats <- function(df, vars) {
  df %>%
    filter(variable %in% vars) %>%
    group_by(group, variable) %>%
    summarise(mean = mean(value, na.rm = TRUE),
              sd = sd(value, na.rm = TRUE),
              n = n(), .groups = "drop")
}

# Function to run t-tests for pairwise comparisons
run_t_tests <- function(df, vars) {
  t_test_results <- lapply(vars, function(var) {
    # T-tests: Control vs. each treatment arm
    control_vs_treatment <- t.test(value ~ group, data = df %>% filter(group %in% c("Control", "Treatment1"), variable == var))
    
    # Treatment comparisons: make sure there's only two groups
    treatment_comparisons <- lapply(c("Treatment1", "Treatment2", "Treatment3"), function(treatment_group) {
      # Check if both groups have data
      treatment_data <- df %>% filter(group %in% c("Treatment1", treatment_group), variable == var)
      
      if (n_distinct(treatment_data$group) == 2) {
        return(t.test(value ~ group, data = treatment_data))
      } else {
        return(NULL)  # Skip the comparison if there's not exactly 2 groups
      }
    })
    
    # Return t-test results
    list(
      control_vs_treatment = control_vs_treatment,
      treatment_comparisons = treatment_comparisons
    )
  })
  
  return(t_test_results)
}

# Function to tidy t-test results into a table
tidy_t_tests <- function(t_test_results, vars) {
  results <- lapply(seq_along(t_test_results), function(i) {
    # Extract results for each variable
    var <- vars[i]
    
    # Control vs Treatment t-test results
    control_vs_treatment <- tidy(t_test_results[[i]]$control_vs_treatment) %>%
      mutate(variable = var, comparison = "Control vs Treatment1")
    
    # Pairwise treatment comparisons
    treatment_comparisons <- bind_rows(lapply(1:3, function(j) {
      treatment_result <- t_test_results[[i]]$treatment_comparisons[[j]]
      
      if (!is.null(treatment_result)) {
        tidy(treatment_result) %>%
          mutate(variable = var, comparison = paste("Treatment", j, "vs Treatment", j+1))
      } else {
        NULL
      }
    }))
    
    # Combine control vs treatment and pairwise treatment comparisons
    bind_rows(control_vs_treatment, treatment_comparisons)
  })
  
  # Combine results for all variables into one data frame
  bind_rows(results)
}

# Define the list of variables to test
vars_to_test <- c("hh_08", "hh_09", "hh_10")

# Compute summary statistics for all variables
summary_stats <- compute_summary_stats(balance_df, vars_to_test)

# Run t-tests for each variable
t_test_results <- run_t_tests(balance_df, vars_to_test)

# Create a tidy table from the t-test results
tidy_results <- tidy_t_tests(t_test_results, vars_to_test)

# Print the summary stats
print(summary_stats)

# Print the tidy t-test results
print(tidy_results)

```

